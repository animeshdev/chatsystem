 <!DOCTYPE html>
<html ng-app="myApps">
<meta charset="utf-8">
<title>Contacts</title>
<meta name="viewport" content="width=device-width">

<base href="/">

<script src='/lib/angular/angular.min.js'></script>
<script src='lib/angular-route/angular-route.min.js'></script>
<script src='lib/angular-resource/angular-resource.min.js'></script>

<style>
  .overflowable {
  height: 240px;
  overflow-y: auto;
  border: 1px solid #000;
}

.overflowable p {
  margin: 0;
}

.col {
  float: left;
  width: 350px;
}

.clr {
  clear: both;
}
</style>
<div ng-controller="AppCtrl">
  <div class="col"><h3>Messages</h3>
    <div class="overflow">
      <p ng-repeat='message in messages'>{{message.user}}: {{message.text}}</p>
    </div>
  </div>
  <div class="col"><h3>Users</h3>
    <div class="overflow">
      <p ng-repeat='user in users'>{{user}}</p>
    </div>
  </div>


  <div class="clr">
    <form ng-submit='sendMessage()'>
      
      <label for="">Message</label>
      <input size='60', ng-model='message'>
      <input type="submit" value='Send'>
    </form>
  </div>


  <div class="clr">

    <h3>Change your name</h3>
    <p>Your current user name is {{name}}</p>
    <form ng-submit='changeName()'>
      <label for="">New Name</label>
      <input size='60', ng-model='newName'>
      <input type="submit" value='Change Name'>
    </form>
  </div>

</div>
<script src='/lib/socket/socket.io.js'></script>
<script>
angular.module('myApps', ['ngResource','ngRoute'])
.controller('AppCtrl', function ($scope, socket) { 

  socket.on('init', function (data) {
    $scope.name = data.name;
    $scope.users = data.users;
  });

  socket.on('newMessage', function (message) {
    $scope.messages.push(message);
  });

  socket.on('change:name', function (data) {
    changeName(data.oldName, data.newName);
  });

  socket.on('user:join', function (data) {
    $scope.messages.push({
      user: 'chatroom',
      text: 'User ' + data.name + ' has joined.'
    });
    $scope.users.push(data.name);
  });

  // add a message to the conversation when a user disconnects or leaves the room
  socket.on('user:left', function (data) {
    $scope.messages.push({
      user: 'chatroom',
      text: 'User ' + data.name + ' has left.'
    });
    var i, user;
    for (i = 0; i < $scope.users.length; i++) {
      user = $scope.users[i];
      if (user === data.name) {
        $scope.users.splice(i, 1);
        break;
      }
    }
  });

  // Private helpers
  // ===============

  var changeName = function (oldName, newName) {
    // rename user in list of users
    var i;
    for (i = 0; i < $scope.users.length; i++) {
      if ($scope.users[i] === oldName) {
        $scope.users[i] = newName;
      }
    }

    $scope.messages.push({
      user: 'chatroom',
      text: 'User ' + oldName + ' is now known as ' + newName + '.'
    });
  }

  // Methods published to the scope
  // ==============================

  $scope.changeName = function () {
    socket.emit('change:name', {
      name: $scope.newName
    }, function (result) {
      if (!result) {
        alert('There was an error changing your name');
      } else {
        
        changeName($scope.name, $scope.newName);

        $scope.name = $scope.newName;
        $scope.newName = '';
      }
    });
  };

  $scope.messages = [];

  $scope.sendMessage = function () {
    socket.emit('newMessage', {
      msg: $scope.message,
      room: 'MainRoom'
    });

    // add the message to our model locally
    $scope.messages.push({
      user: $scope.name,
      text: $scope.message
    });

    // clear message box
    $scope.message = '';
  };
})


.factory('socket', function ($rootScope) {
  var socket = io.connect();
  return {
    on: function (eventName, callback) {
      socket.on(eventName, function () {  
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      });
    },
    emit: function (eventName, data, callback) {
      socket.emit(eventName, data, function () {
        var args = arguments;
        $rootScope.$apply(function () {
          if (callback) {
            callback.apply(socket, args);
          }
        });
      })
    }
  };
})
;
</script>
 